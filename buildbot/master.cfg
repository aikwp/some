# -*- python -*-
# Buildbot configuration for Android Python builds (aarch64)
# Source: python.org official tarballs
# by NotFound / zrsx

from buildbot.plugins import util, steps, schedulers, workers

c = BuildmasterConfig = {}

####### WORKERS #######

c['workers'] = [workers.Worker("macos-worker", "password123")]
c['protocols'] = {'pb': {'port': 9989}}

####### SCHEDULERS #######

c['schedulers'] = [
    schedulers.ForceScheduler(
        name="force",
        builderNames=[
            "build-android-3.13",
            "build-android-3.14",
            "build-android-3.15",
        ]
    ),
]

####### BUILDER TEMPLATE #######

def make_android_builder(full_version, short_version):
    """
    full_version: exact version tag from python.org (e.g. 3.13.9)
    short_version: used for patch branch (e.g. 3.13)
    """
    return util.BuilderConfig(
        name=f"build-android-{short_version}",
        workernames=["macos-worker"],
        factory=util.BuildFactory([
            # Step 1: Download source tarball from python.org
            steps.ShellCommand(
                name="download-source",
                command=[
                    "bash", "-c",
                    (
                        f"set -euxo pipefail;"
                        f"PYTHON_VERSION={full_version};"
                        f"curl -LO https://www.python.org/ftp/python/$PYTHON_VERSION/Python-$PYTHON_VERSION.tar.xz;"
                        f"tar -xf Python-$PYTHON_VERSION.tar.xz;"
                        f"mv Python-$PYTHON_VERSION cpython-{short_version}"
                    )
                ]
            ),

            # Step 2: Prepare environment
            steps.ShellCommand(
                name="setup-environment",
                command=[
                    "bash", "-c",
                    (
                        "set -euxo pipefail;"
                        "brew update;"
                        "brew install readline llvm lld dpkg mpdecimal || true;"
                        "brew uninstall gcc || true;"
                        "export LLVM_PATH=/opt/homebrew/opt/llvm/bin;"
                        "echo $LLVM_PATH >> $PATH"
                    )
                ]
            ),

            # Step 3: Apply Termux and version patches (3.13, 3.14 only)
            steps.ShellCommand(
                name="apply-patches",
                doStepIf=lambda step: short_version in ("3.13", "3.14"),
                workdir=f"cpython-{short_version}",
                command=[
                    "bash", "-c",
                    (
                        "set -euxo pipefail;"
                        "curl -L -o termux.patch https://raw.githubusercontent.com/yubrajbhoi/termux-python/refs/heads/main/termux.patch;"
                        "git init >/dev/null 2>&1;"
                        "git add . >/dev/null 2>&1;"
                        "git commit -m init >/dev/null 2>&1;"
                        "git apply termux.patch || echo 'âš ï¸ termux.patch failed â€” continuing.';"
                        f"curl -L -o custom.patch https://raw.githubusercontent.com/plfj/py-build/refs/heads/main/as{short_version.replace('.', '')}.patch;"
                        "git apply custom.patch || echo 'âš ï¸ Version patch failed â€” continuing.'"
                    )
                ]
            ),

            # Step 4: Build CPython for Android
            steps.ShellCommand(
                name="build-cpython",
                workdir=f"cpython-{short_version}/Android",
                command=[
                    "bash", "-c",
                    (
                        "set -euxo pipefail;"
                        "./android.py ci --fast-ci aarch64-linux-android;"
                        f"echo 'âœ… Build finished for version {short_version}';"
                        "ls -lh ../cross-build/aarch64-linux-android || echo 'âš ï¸ Build output not found'"
                    )
                ]
            ),

            # Step 5: Package as .deb
            steps.ShellCommand(
                name="package-deb",
                command=[
                    "bash", "-c",
                    (
                        f"set -euxo pipefail;"
                        f"VERSION={short_version};"
                        "PKG_NAME=pyv${VERSION//./};"
                        "ARCH=aarch64;"
                        f"BUILD_DIR=./cpython-{short_version}/cross-build/${ARCH}-linux-android;"
                        "OUT_DIR=$( [ -d \"$BUILD_DIR/prefix\" ] && echo \"$BUILD_DIR/prefix\" || echo \"$BUILD_DIR/install\" );"
                        "DEB_DIR=$PKG_NAME;"
                        "mkdir -p $DEB_DIR/DEBIAN $DEB_DIR/usr;"
                        "cp -r $OUT_DIR/* $DEB_DIR/usr/;"
                        "cat > $DEB_DIR/DEBIAN/control <<EOF\n"
                        "Package: $PKG_NAME\n"
                        "Version: $VERSION\n"
                        "Architecture: $ARCH\n"
                        "Maintainer: Cross-compiled by NotFound\n"
                        "Description: Python $VERSION cross-compiled for Termux (aarch64)\n"
                        "EOF\n"
                        "cat > $DEB_DIR/DEBIAN/postinst <<'EOF'\n"
                        "#!/bin/sh\n"
                        "set -e\n"
                        "echo 'âœ… $PKG_NAME installed successfully!'\n"
                        "exit 0\n"
                        "EOF\n"
                        "chmod 755 $DEB_DIR/DEBIAN/postinst;"
                        "dpkg-deb --build $DEB_DIR ${PKG_NAME}_${VERSION}_${ARCH}.deb;"
                        "mkdir -p /var/buildbot/artifacts;"
                        "mv ${PKG_NAME}_${VERSION}_${ARCH}.deb /var/buildbot/artifacts/;"
                        f"echo 'ðŸ“¦ Saved artifact for Python {short_version}'"
                    )
                ]
            ),
        ]),
        description=f"Builds Python {short_version} for Android (aarch64) using python.org source",
    )

####### BUILDERS #######

c['builders'] = [
    make_android_builder("3.13.9", "3.13"),
    make_android_builder("3.14.0", "3.14"),
    make_android_builder("3.15.0a1", "3.15"),
]

####### MISC SETTINGS #######

c['title'] = "Android Python Builder"
c['titleURL'] = "https://github.com/zrsx"
c['buildbotURL'] = "http://localhost:8010/"
c['www'] = dict(port=8010, plugins={'waterfall_view': True, 'console_view': True, 'grid_view': True})
